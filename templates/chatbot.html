{% extends 'base.html' %} {% load markdownify %} {% block styles %}
<style>
  :root {
    /* === THEME COLORS === */
    --background-color: #121212;
    --surface-color: #1e1e1e;
    --border-color: #2a2a2a;
    --text-primary: #e0e0e0;
    --text-secondary: #a0a0a0;
    --accent: #00c49f;
    --user-bubble: #00897b;
  }

  @media (prefers-color-scheme: light) {
    :root {
      --background-color: #f5f5f5;
      --surface-color: #ffffff;
      --border-color: #e0e0e0;
      --text-primary: #1e1e1e;
      --text-secondary: #555;
      --accent: #00796b;
      --user-bubble: #009688;
    }
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: "Inter", system-ui, sans-serif;
    background: var(--background-color);
    height: 100vh;
    display: flex;
    flex-direction: column;
    color: var(--text-primary);
  }

  /* === LAYOUT === */
  .chat-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  .chat-header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border-color);
    background: var(--background-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .chat-title {
    font-size: 18px;
    font-weight: 600;
  }

  .auth-buttons a,
  .auth-buttons .logout-btn {
    background: var(--surface-color);
    color: var(--text-primary);
    text-decoration: none;
    padding: 6px 14px;
    border-radius: 18px;
    font-size: 13px;
    border: 1px solid var(--border-color);
    transition: background 0.2s ease;
  }

  .auth-buttons a:hover,
  .auth-buttons .logout-btn:hover {
    background: var(--border-color);
  }

  /* === MESSAGES === */
  .messages-box {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    scroll-behavior: smooth;
  }

  .message {
    margin-bottom: 16px;
    display: flex;
    animation: fadeIn 0.25s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message-content {
    max-width: 70%;
    padding: 12px 18px;
    border-radius: 18px;
    font-size: 14px;
    line-height: 1.5;
    word-break: break-word;
  }

  .sent {
    justify-content: flex-end;
  }
  .sent .message-content {
    background: var(--user-bubble);
    color: #fff;
    border-bottom-right-radius: 6px;
  }

  .received .message-content {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 6px;
  }

  .message-sender {
    font-size: 12px;
    margin-bottom: 4px;
    color: var(--text-secondary);
  }

  /* === INPUT AREA === */
  .message-form {
    padding: 12px 20px;
    border-top: 1px solid var(--border-color);
    background: var(--background-color);
  }

  .input-group {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 6px 10px;
  }

  .message-input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-primary);
    font-size: 14px;
    resize: none;
    min-height: 32px;
    max-height: 150px;
    outline: none;
  }

  .btn-send {
    width: 38px;
    height: 38px;
    background: var(--accent);
    border: none;
    border-radius: 50%;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition:
      transform 0.2s ease,
      background 0.2s ease;
  }
  .btn-send:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .btn-send:hover:not(:disabled) {
    transform: scale(1.05);
  }

  /* === TYPING INDICATOR === */
  .typing-indicator {
    display: none;
    margin: 0 0 16px 0;
  }
  .typing-dots {
    background: var(--surface-color);
    border: 1px solid var(--border-color);
    border-radius: 18px;
    padding: 8px 14px;
  }
  .typing-dot {
    width: 6px;
    height: 6px;
    background: var(--text-secondary);
    border-radius: 50%;
    display: inline-block;
    margin-right: 4px;
    animation: typing 1.4s infinite;
  }
  .typing-dot:nth-child(2) {
    animation-delay: 0.2s;
  }
  .typing-dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes typing {
    0%,
    60%,
    100% {
      transform: translateY(0);
      opacity: 0.5;
    }
    30% {
      transform: translateY(-4px);
      opacity: 1;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="chat-container">
  <!-- HEADER -->
  <div class="chat-header">
    <div class="chat-title">ðŸ’¬ Chat</div>
    <div class="auth-section">
      {% if user.is_authenticated %}
      <span class="welcome-text">Welcome, {{ user.username }}</span>
      <div class="auth-buttons">
        <a href="{% url 'chatbot:logout' %}" class="logout-btn">Logout</a>
      </div>
      {% else %}
      <div class="auth-buttons">
        <a href="{% url 'chatbot:login' %}">Login</a>
        <a href="{% url 'chatbot:register' %}">Register</a>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- CHAT BODY -->
  <div class="messages-box">
    <ul class="messages-list">
      <li class="message received">
        <div class="message-content">
          <div class="message-sender">AI Chatbot</div>
          Hi {% if user.is_authenticated %}{{ user.username }}{% else %}there{%
          endif %}, I am your AI Chatbot. You can ask me anything.
        </div>
      </li>

      {% for chat in chats %}
      <li class="message sent">
        <div class="message-content">{{ chat.message }}</div>
      </li>
      <li class="message received">
        <div class="message-content">
          <div class="message-sender">AI Chatbot</div>
          {{ chat.response | markdownify }}
        </div>
      </li>
      {% endfor %}

      <li class="typing-indicator" id="typingIndicator">
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </li>
    </ul>
  </div>

  <!-- INPUT AREA -->
  <form class="message-form">
    {% csrf_token %}
    <div class="input-group">
      <textarea
        class="message-input"
        placeholder="Type a message..."
        rows="1"
        aria-label="Message input"
        oninput="autoResizeTextarea(this)"
      ></textarea>
      <button type="submit" class="btn-send" aria-label="Send message" disabled>
        <svg
          class="send-icon"
          width="18"
          height="18"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </form>
</div>

<script>
  const messagesList = document.querySelector(".messages-list");
  const messageForm = document.querySelector(".message-form");
  const messageInput = document.querySelector(".message-input");
  const typingIndicator = document.getElementById("typingIndicator");
  const messagesBox = document.querySelector(".messages-box");
  const sendButton = document.querySelector(".btn-send");

  function scrollToBottom() {
    messagesBox.scrollTop = messagesBox.scrollHeight;
  }

  function showTypingIndicator() {
    typingIndicator.style.display = "flex";
    scrollToBottom();
  }

  function hideTypingIndicator() {
    typingIndicator.style.display = "none";
  }

  function autoResizeTextarea(textarea) {
    textarea.style.height = "auto";
    textarea.style.height = textarea.scrollHeight + "px";
    sendButton.disabled = textarea.value.trim().length === 0;
  }

  window.addEventListener("load", () => {
    scrollToBottom();
    messageInput.focus();
  });

  messageForm.addEventListener("submit", (event) => {
    event.preventDefault();
    const message = messageInput.value.trim();
    if (!message) return;

    const messageItem = document.createElement("li");
    messageItem.classList.add("message", "sent");
    messageItem.innerHTML = `<div class="message-content">${message}</div>`;
    messagesList.insertBefore(messageItem, typingIndicator);

    messageInput.value = "";
    autoResizeTextarea(messageInput);
    showTypingIndicator();

    fetch("", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        csrfmiddlewaretoken: document.querySelector(
          "[name=csrfmiddlewaretoken]",
        ).value,
        message: message,
      }),
    })
      .then((res) => res.json())
      .then((data) => {
        hideTypingIndicator();
        const responseItem = document.createElement("li");
        responseItem.classList.add("message", "received");
        responseItem.innerHTML = `
                <div class="message-content">
                    <div class="message-sender">AI Chatbot</div>
                    ${data.response}
                </div>`;
        messagesList.insertBefore(responseItem, typingIndicator);
        scrollToBottom();
      })
      .catch((err) => {
        hideTypingIndicator();
        console.error("Error:", err);
      });
  });

  messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      messageForm.dispatchEvent(new Event("submit"));
    }
  });
</script>
{% endblock %}
